<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-operations/container-image-caching-with-harbor/index" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Container image caching with Harbor | Moreh</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://test-docs.moreh.io/dev/operations/container-image-caching-with-harbor/"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Container image caching with Harbor | Moreh"><meta data-rh="true" name="description" content="The container images composing the MoAI Inference Framework are distributed through Amazon ECR. Although this approach works well in general, fetching images from a remote registry during deployment and scaling of inference environments may incur substantial delays."><meta data-rh="true" property="og:description" content="The container images composing the MoAI Inference Framework are distributed through Amazon ECR. Although this approach works well in general, fetching images from a remote registry during deployment and scaling of inference environments may incur substantial delays."><link data-rh="true" rel="icon" href="/moreh-icon.png"><link data-rh="true" rel="canonical" href="https://test-docs.moreh.io/dev/operations/container-image-caching-with-harbor/"><link data-rh="true" rel="alternate" href="https://test-docs.moreh.io/dev/operations/container-image-caching-with-harbor/" hreflang="en"><link data-rh="true" rel="alternate" href="https://test-docs.moreh.io/dev/operations/container-image-caching-with-harbor/" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Container image caching (Harbor)","item":"https://test-docs.moreh.io/dev/operations/container-image-caching-with-harbor/"}]}</script><link rel="stylesheet" href="/assets/css/styles.d347868e.css">
<script src="/assets/js/runtime~main.68118f1f.js" defer="defer"></script>
<script src="/assets/js/main.7d4cef61.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),document.documentElement.setAttribute("data-theme-choice",t||"system")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/moreh-logo.svg" alt="Moreh logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/moreh-logo-white.svg" alt="Moreh logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate"></b></a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a aria-current="page" class="navbar__link active" aria-haspopup="true" aria-expanded="false" role="button" href="/dev/operations/container-image-caching-with-harbor/">Dev ðŸš§</a><ul class="dropdown__menu"><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/dev/operations/container-image-caching-with-harbor/">Dev ðŸš§</a></li><li><a class="dropdown__link" href="/">v0.0.0</a></li></ul></div><a href="https://moreh.io/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Website<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/moreh-dev/mif" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><div class="dsla-search-wrapper"><div class="dsla-search-field" data-tags="default,docs-default-current"></div></div></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/dev/getting-started/prerequisites/"><span title="Getting Started" class="categoryLinkLabel_W154">Getting Started</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/getting-started/prerequisites/"><span title="Prerequisites" class="linkLabel_WmDU">Prerequisites</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/getting-started/quickstart/"><span title="Quickstart" class="linkLabel_WmDU">Quickstart</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/dev/features/preset/"><span title="Features" class="categoryLinkLabel_W154">Features</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/features/preset/"><span title="Presets" class="linkLabel_WmDU">Presets</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/dev/operations/hf-model-management-with-pv/"><span title="Operations" class="categoryLinkLabel_W154">Operations</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/operations/hf-model-management-with-pv/"><span title="HF Model Management (PV)" class="linkLabel_WmDU">HF Model Management (PV)</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/dev/operations/container-image-caching-with-harbor/"><span title="Container image caching (Harbor)" class="linkLabel_WmDU">Container image caching (Harbor)</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/dev/reference/heimdall/api-reference/"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" tabindex="0" href="/dev/reference/heimdall/api-reference/"><span title="Heimdall" class="categoryLinkLabel_W154">Heimdall</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/reference/heimdall/api-reference/"><span title="API Reference" class="linkLabel_WmDU">API Reference</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/reference/heimdall/plugins/"><span title="Plugins" class="linkLabel_WmDU">Plugins</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" tabindex="0" href="/dev/reference/odin/api-reference/"><span title="Odin" class="categoryLinkLabel_W154">Odin</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/reference/odin/api-reference/"><span title="API Reference" class="linkLabel_WmDU">API Reference</span></a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/dev/reference/supported-devices/"><span title="Supported devices" class="linkLabel_WmDU">Supported devices</span></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="theme-doc-version-banner alert alert--warning margin-bottom--md" role="alert"><div>This is unreleased documentation for <!-- -->Moreh<!-- --> <b>Dev ðŸš§</b> version.</div><div class="margin-top--md">For up-to-date documentation, see the <b><a href="/">latest version</a></b> (<!-- -->v0.0.0<!-- -->).</div></div><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Operations</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Container image caching (Harbor)</span></li></ul></nav><span class="theme-doc-version-badge badge badge--secondary">Version: Dev ðŸš§</span><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Container image caching with Harbor</h1></header><p>The container images composing the MoAI Inference Framework are distributed through Amazon ECR. Although this approach works well in general, fetching images from a remote registry during deployment and scaling of inference environments may incur substantial delays.</p>
<p>This document explains how to build a local image registry with <a href="https://goharbor.io/" target="_blank" rel="noopener noreferrer" class="">Harbor</a>, automatically cache container images in Moreh&#x27;s upstream Amazon ECR registry, and use them when deploying production inference environments. It covers the following high-level flow.</p>
<ol>
<li class="">Installing Harbor and configuring HTTP/HTTPS access.</li>
<li class="">Registering Moreh&#x27;s Amazon ECR as a registry endpoint in Harbor.</li>
<li class="">Creating a Harbor project to cache or replicate images.</li>
<li class="">Configuring Kubernetes nodes to pull images from Harbor instead of ECR.</li>
</ol>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="install-harbor">Install Harbor<a href="#install-harbor" class="hash-link" aria-label="Direct link to Install Harbor" title="Direct link to Install Harbor" translate="no">â€‹</a></h2>
<p>Refer to <a href="https://goharbor.io/docs/latest/install-config/" target="_blank" rel="noopener noreferrer" class="">Harbor Installation and Configuration</a> for more details.</p>
<p>Pull a chart from the Harbor Helm repository.</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">helm repo </span><span class="token function" style="color:rgb(220, 220, 170)">add</span><span class="token plain"> harbor https://helm.goharbor.io</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">helm repo update harbor</span><br></span></code></pre></div></div>
<p>Decide whether to configure Harbor over HTTP (insecure but simple) or HTTPS, depending on your environment. Then, deploy Harbor using the following command. <strong>If you choose HTTPS, the <code>externalURL</code> must start with <code>https://</code> instead of <code>http://</code>. You also need to replace <code>&lt;password&gt;</code> and <code>&lt;storageClass&gt;</code> with your own values.</strong></p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">helm upgrade </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-i</span><span class="token plain"> harbor harbor/harbor </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--version</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1.18</span><span class="token plain">.2 </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-n</span><span class="token plain"> harbor </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    --create-namespace </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> harborAdminPassword </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">password</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> persistence.persistentVolumeClaim.registry.storageClass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">storageClass</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> persistence.persistentVolumeClaim.jobservice.jobLog.storageClass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">storageClass</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> persistence.persistentVolumeClaim.database.storageClass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">storageClass</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> persistence.persistentVolumeClaim.redis.storageClass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">storageClass</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> persistence.persistentVolumeClaim.trivy.storageClass </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">storageClass</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> externalURL http://harbor.harbor.svc.cluster.local </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> expose.tls.enabled </span><span class="token boolean">true</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> expose.tls.certSource secret </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">--set</span><span class="token plain"> expose.tls.secret.secretName harbor-tls</span><br></span></code></pre></div></div>
<div class="theme-admonition theme-admonition-info admonition_xJq3 alert alert--info"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 14 16"><path fill-rule="evenodd" d="M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"></path></svg></span>info</div><div class="admonitionContent_BuS1"><p>If you want to modify additional configurations beyond those specified in the command above to better fit your cluster environment, you can customize and use the <a href="https://github.com/goharbor/harbor-helm/blob/main/values.yaml" target="_blank" rel="noopener noreferrer" class="">values.yaml</a> file provided by Harbor.</p></div></div>
<p>Then, apply additional configuration depending on whether you are using HTTP or HTTPS.</p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="httphttps-configuration">HTTP/HTTPS configuration<a href="#httphttps-configuration" class="hash-link" aria-label="Direct link to HTTP/HTTPS configuration" title="Direct link to HTTP/HTTPS configuration" translate="no">â€‹</a></h2>
<p>Harbor can be exposed over HTTP(insecure) or HTTPS. Choose one based on your environment.</p>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">HTTP (Default)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">HTTPS</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This configuration must be applied to <strong>all nodes</strong>.</p></div></div><p>If you want to use HTTP, your container runtime must allow an <strong>insecure registry</strong> for the Harbor endpoint; otherwise image pulls may fail.</p><p><strong>Configure containerd</strong></p><p>Configure the registry as insecure:</p><div class="language-toml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockTitle_OeMC">/etc/containerd/config.toml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-toml codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token table class-name" style="color:rgb(78, 201, 176)">plugins</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token punctuation" style="color:rgb(212, 212, 212)">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token table class-name" style="color:rgb(78, 201, 176)">plugins.&quot;io.containerd.cri.v1.images&quot;.registry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key property">config_path</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">=</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&quot;/etc/containerd/certs.d&quot;</span><br></span></code></pre></div></div><p>Create a registry host file.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-p</span><span class="token plain"> /etc/containerd/certs.d/harbor.harbor.svc.cluster.local:80</span><br></span></code></pre></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">cat</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> /etc/containerd/certs.d/harbor.harbor.svc.cluster.local:80/hosts.toml </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">server = &quot;https://harbor.harbor.svc.cluster.local:80&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">[host.&quot;http://harbor.harbor.svc.cluster.local:80&quot;]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  capabilities = [&quot;pull&quot;,&quot;resolve&quot;,&quot;push&quot;]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  skip_verify = true</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  override_path = false</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">EOF</span><br></span></code></pre></div></div><p><strong>Restart containerd</strong></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> systemctl restart containerd</span><br></span></code></pre></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p>Configure TLS for Harbor using either:</p><ul>
<li class="">a public certificate, or</li>
<li class="">an internal CA / self-signed certificate (ensure the CA is trusted by clients).</li>
</ul><p>If you expose Harbor with Ingress, you can terminate TLS at the ingress controller and route traffic to Harbor services. If you use a self-signed certificate, make sure Kubernetes nodes (container runtime) trust the CA certificate; otherwise image pulls may fail with x509 errors.
In this document we use <code>ClusterIP</code> and issue certificates with <a class="" href="/dev/getting-started/prerequisites/#cert-manager">cert-manager</a>.</p><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>If you use this approach, make sure to account for certificate expiration.</p></div></div><p>Following manifest creates root CA(harbor-ca) and TLS certificate(harbor-tls).</p><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockTitle_OeMC">harbor-tls.yaml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token punctuation" style="color:rgb(212, 212, 212)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">manager.io/v1</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Issuer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">selfsigned</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">selfSigned</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">manager.io/v1</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Certificate</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ca</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">isCA</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">commonName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ca</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">secretName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ca</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">privateKey</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">algorithm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> RSA</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">issuerRef</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">selfsigned</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Issuer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">manager.io/v1</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Issuer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ca</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">issuer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">ca</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">secretName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ca</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token punctuation" style="color:rgb(212, 212, 212)">---</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> cert</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">manager.io/v1</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Certificate</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">tls</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">namespace</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">secretName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">tls</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">commonName</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor.harbor.svc.cluster.local</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">dnsNames</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> harbor.harbor.svc.cluster.local</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> harbor</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> harbor.harbor</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">privateKey</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">algorithm</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> RSA</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">size</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">2048</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">issuerRef</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> harbor</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">ca</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">issuer</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Issuer</span><br></span></code></pre></div></div><p>Then create certificates with following command.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-f</span><span class="token plain"> harbor-tls.yaml</span><br></span></code></pre></div></div><p>Confirm resources are ready.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-n</span><span class="token plain"> harbor get issuer,certificate</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-n</span><span class="token plain"> harbor describe certificate harbor-tls</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-n</span><span class="token plain"> harbor get secret harbor-tls</span><br></span></code></pre></div></div><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This configuration must be applied to <strong>all nodes</strong>.</p></div></div><p>Extract the root CA from the secret and add it to containerd&#x27;s trust store.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl get secret </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-n</span><span class="token plain"> harbor harbor-ca </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-o</span><span class="token plain"> </span><span class="token assign-left variable" style="color:rgb(156, 220, 254)">jsonpath</span><span class="token operator" style="color:rgb(212, 212, 212)">=</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{.data.ca\.crt}&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> base64 </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-d</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> harbor-ca.crt</span><br></span></code></pre></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-p</span><span class="token plain"> /etc/containerd/certs.d/harbor.harbor.svc.cluster.local:443</span><br></span></code></pre></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">cp</span><span class="token plain"> harbor-ca.crt /etc/containerd/certs.d/harbor.harbor.svc.cluster.local:443/ca.crt</span><br></span></code></pre></div></div><p><strong>Create a registry host file</strong></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">cat</span><span class="token plain"> </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain"> /etc/containerd/certs.d/harbor.harbor.svc.cluster.local:443/hosts.toml </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&lt;</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">server = &quot;https://harbor.harbor.svc.cluster.local:443&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">[host.&quot;https://harbor.harbor.svc.cluster.local:443&quot;]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  capabilities = [&quot;pull&quot;,&quot;resolve&quot;,&quot;push&quot;]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  ca = &quot;/etc/containerd/certs.d/harbor.harbor.svc.cluster.local:443/ca.crt&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  override_path = false</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">EOF</span><br></span></code></pre></div></div><p><strong>Restart containerd</strong></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> systemctl restart containerd</span><br></span></code></pre></div></div></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="register-moreh-ecr-endpoint">Register Moreh ECR endpoint<a href="#register-moreh-ecr-endpoint" class="hash-link" aria-label="Direct link to Register Moreh ECR endpoint" title="Direct link to Register Moreh ECR endpoint" translate="no">â€‹</a></h2>
<p><strong>Administration</strong> &gt; <strong>Registries</strong> &gt; <strong>New Endpoint</strong></p>
<ul>
<li class="">Provider: AWS ECR</li>
<li class="">Endpoint URL: <code>https://255250787067.dkr.ecr.ap-northeast-2.amazonaws.com</code></li>
<li class="">Please refer to <a class="" href="/dev/getting-started/prerequisites/#moai-inference-framework">moai-inference-framework</a> for the <code>Access ID</code> and <code>Access Secret</code>.</li>
</ul>
<p><img decoding="async" loading="lazy" alt="Create New Endpoint" src="/assets/images/registry-endpoint-6ede649942defe6b52cb84b5efc0d00c.png" width="1494" height="1362" class="img_ev3q"></p>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="create-harbor-project">Create Harbor project<a href="#create-harbor-project" class="hash-link" aria-label="Direct link to Create Harbor project" title="Direct link to Create Harbor project" translate="no">â€‹</a></h2>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Proxy cache (Default)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Replication</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><p>This approach makes the container runtime pull images through Harbor as a proxy (pull-through cache). Images are cached on demand when they are first pulled.</p><p><strong>Create a project</strong></p><p>Create a new Harbor project and enable <strong>Proxy cache</strong>.</p><p><img decoding="async" loading="lazy" alt="Create New Project as Proxy" src="/assets/images/proxy-project-65b8238014a970240035171c3535ea4a.png" width="1500" height="1276" class="img_ev3q"></p></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p><strong>Create a project</strong></p><p><strong>Projects</strong> &gt; <strong>New Project</strong></p><p><img decoding="async" loading="lazy" alt="Create New Project" src="/assets/images/project-4b9af5e637580307f57df22eda676678.png" width="1492" height="1284" class="img_ev3q"></p><p><strong>Create a Harbor replication rule</strong></p><p><strong>Administration</strong> &gt; <strong>Replications</strong> &gt; <strong>New Replication Rule</strong></p><p><img decoding="async" loading="lazy" alt="Create New Replication Rule" src="/assets/images/replication-rule-53eeaebfc4c1dfeb0509b03cc399dd73.png" width="1556" height="1546" class="img_ev3q"></p><p><strong>Replication rule must be triggered to mirror images from ECR into Harbor project.</strong></p></div></div></div>
<hr>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="configure-mirror-or-rewrite-image-path">Configure mirror or rewrite image path<a href="#configure-mirror-or-rewrite-image-path" class="hash-link" aria-label="Direct link to Configure mirror or rewrite image path" title="Direct link to Configure mirror or rewrite image path" translate="no">â€‹</a></h2>
<div class="theme-tabs-container tabs-container tabList__CuJ"><ul role="tablist" aria-orientation="horizontal" class="tabs"><li role="tab" tabindex="0" aria-selected="true" class="tabs__item tabItem_LNqP tabs__item--active">Containerd mirror (Default)</li><li role="tab" tabindex="-1" aria-selected="false" class="tabs__item tabItem_LNqP">Kyverno rewrite</li></ul><div class="margin-top--md"><div role="tabpanel" class="tabItem_Ymn6"><div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>This configuration must be applied to <strong>all nodes</strong>.</p></div></div><p>On every node that may pull images, create the directory and <code>hosts.toml</code> file below.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">mkdir</span><span class="token plain"> </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-p</span><span class="token plain"> /etc/containerd/certs.d/255250787067.dkr.ecr.ap-northeast-2.amazonaws.com</span><br></span></code></pre></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> </span><span class="token function" style="color:rgb(220, 220, 170)">tee</span><span class="token plain"> /etc/containerd/certs.d/255250787067.dkr.ecr.ap-northeast-2.amazonaws.com/hosts.toml </span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">/dev/null </span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;&lt;</span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;EOF&#x27;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">server = &quot;https://255250787067.dkr.ecr.ap-northeast-2.amazonaws.com&quot;</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)"># [host.&quot;https://harbor.harbor.svc.cluster.local:443/v2/mif&quot;]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">[host.&quot;http://harbor.harbor.svc.cluster.local:80/v2/mif&quot;]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  capabilities = [&quot;pull&quot;,&quot;resolve&quot;]</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  skip_verify = true</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">  override_path = false</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token string" style="color:rgb(206, 145, 120)">EOF</span><br></span></code></pre></div></div><p><strong>Restart containerd</strong></p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> systemctl restart containerd</span><br></span></code></pre></div></div><p>For verifying, Pull an image once from any node configured and then confirm the image cached under the proxy cache project(mif) in Harbor web UI.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token function" style="color:rgb(220, 220, 170)">sudo</span><span class="token plain"> crictl pull </span><span class="token punctuation" style="color:rgb(212, 212, 212)">\</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token number" style="color:rgb(181, 206, 168)">255250787067</span><span class="token plain">.dkr.ecr.ap-northeast-2.amazonaws.com/quickstart/</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">image</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><span class="token plain">:</span><span class="token operator" style="color:rgb(212, 212, 212)">&lt;</span><span class="token plain">tag</span><span class="token operator" style="color:rgb(212, 212, 212)">&gt;</span><br></span></code></pre></div></div></div><div role="tabpanel" class="tabItem_Ymn6" hidden=""><p><a href="https://kyverno.io/docs/introduction/" target="_blank" rel="noopener noreferrer" class="">Kyverno</a> is Kubernetes-native policy engine that enforces guardrails and automates operations using policy-as-code (YAML). It runs as a dynamic admission controller, evaluating requests sent to the Kubernetes API server and can <code>validate</code> or <code>mutate</code> resources at admission time.</p><p>Kyverno can be used to rewrite container image references so that workloads which originally point to Amazon ECR will instead pull images from your local Harbor registry (after you mirror the images to Harbor).</p><p>Deploy <code>kyverno</code> using the following command:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl create </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-f</span><span class="token plain"> https://github.com/kyverno/kyverno/releases/latest/download/install.yaml</span><br></span></code></pre></div></div><div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockTitle_OeMC">clusterpolicy.yaml</div><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token key atrule">apiVersion</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> kyverno.io/v1</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">kind</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> ClusterPolicy</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">metadata</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> ecr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">rewrite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">registry</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain"></span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">admission</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">background</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">emitWarning</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">false</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">rules</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token key atrule">any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">mutate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token key atrule">foreach</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> request.object.spec.containers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">patchStrategicMerge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token key atrule">containers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># set registry port as your setup (80 or 443)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{{ regex_replace_all_literal(&quot;255250787067.dkr.ecr.ap-northeast-2.amazonaws.com&quot;, &quot;{{ element.image }}, &quot;harbor.harbor.svc.cluster.local:&lt;yourPort&gt;/mif&quot;) }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{{ element.name }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> ecr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">rewrite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">registry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">skipBackgroundRequests</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">    </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">match</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token key atrule">any</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">resources</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token key atrule">kinds</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> Pod</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">mutate</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token key atrule">foreach</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">list</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> request.object.spec.initContainers</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">patchStrategicMerge</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">              </span><span class="token key atrule">spec</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                </span><span class="token key atrule">initContainers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token comment" style="color:rgb(106, 153, 85)"># set registry port as your setup (80 or 443)</span><span class="token plain"></span><br></span><span class="token-line theme-code-block-highlighted-line" style="color:#9CDCFE"><span class="token plain">                  </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">image</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{{ regex_replace_all_literal(&quot;255250787067.dkr.ecr.ap-northeast-2.amazonaws.com&quot;, &quot;{{ element.image }}, &quot;harbor.harbor.svc.cluster.local:&lt;yourPort&gt;/mif&quot;) }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">                    </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token string" style="color:rgb(206, 145, 120)">&#x27;{{ element.name }}&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">name</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> ecr</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">rewrite</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">registry</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">init</span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain">container</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">preconditions</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">        </span><span class="token key atrule">all</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">          </span><span class="token punctuation" style="color:rgb(212, 212, 212)">-</span><span class="token plain"> </span><span class="token key atrule">key</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> &#x27;</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token punctuation" style="color:rgb(212, 212, 212)">{</span><span class="token plain"> request.object.spec.initContainers</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain"> </span><span class="token punctuation" style="color:rgb(212, 212, 212)">|</span><span class="token punctuation" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> `</span><span class="token punctuation" style="color:rgb(212, 212, 212)">[</span><span class="token punctuation" style="color:rgb(212, 212, 212)">]</span><span class="token plain">` </span><span class="token punctuation" style="color:rgb(212, 212, 212)">|</span><span class="token plain"> length(@) </span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token punctuation" style="color:rgb(212, 212, 212)">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">operator</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> GreaterThanOrEquals</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">            </span><span class="token key atrule">value</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token number" style="color:rgb(181, 206, 168)">1</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">      </span><span class="token key atrule">skipBackgroundRequests</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> </span><span class="token boolean important">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">  </span><span class="token key atrule">validationFailureAction</span><span class="token punctuation" style="color:rgb(212, 212, 212)">:</span><span class="token plain"> Audit</span><br></span></code></pre></div></div><p>Create a <code>ClusterPolicy</code>:</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl apply </span><span class="token parameter variable" style="color:rgb(156, 220, 254)">-f</span><span class="token plain"> clusterpolicy.yaml</span><br></span></code></pre></div></div><p>If you want to check policy status, then follow this command.</p><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">kubectl get clusterpolicy</span><br></span></code></pre></div></div><div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#9CDCFE;--prism-background-color:#1E1E1E"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#9CDCFE;background-color:#1E1E1E"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#9CDCFE"><span class="token plain">NAME                   ADMISSION   BACKGROUND   READY   AGE   MESSAGE</span><br></span><span class="token-line" style="color:#9CDCFE"><span class="token plain">ecr-rewrite-registry   </span><span class="token boolean">true</span><span class="token plain">        </span><span class="token boolean">true</span><span class="token plain">         True    19h   Ready</span><br></span></code></pre></div></div></div></div></div></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/dev/operations/hf-model-management-with-pv/"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">HF Model Management (PV)</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/dev/reference/heimdall/api-reference/"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">API Reference</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#install-harbor" class="table-of-contents__link toc-highlight">Install Harbor</a></li><li><a href="#httphttps-configuration" class="table-of-contents__link toc-highlight">HTTP/HTTPS configuration</a></li><li><a href="#register-moreh-ecr-endpoint" class="table-of-contents__link toc-highlight">Register Moreh ECR endpoint</a></li><li><a href="#create-harbor-project" class="table-of-contents__link toc-highlight">Create Harbor project</a></li><li><a href="#configure-mirror-or-rewrite-image-path" class="table-of-contents__link toc-highlight">Configure mirror or rewrite image path</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="footer__bottom text--center"><div class="footer__copyright">Â© Copyright 2026 Moreh, Inc. All rights reserved.</div></div></div></footer></div>
</body>
</html>