"use strict";(self.webpackChunkmif_docs=self.webpackChunkmif_docs||[]).push([[9750],{9419(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>r,toc:()=>o});const r=JSON.parse('{"id":"reference/heimdall_scheduler","title":"Heimdall scheduler","description":"Heimdall is the component that performs smart routing and scheduling across multiple inference pods, deciding which pod each request should be sent to. It is implemented according to the Kubernetes Gateway API Inference Extension and can operate together with various gateway controllers.","source":"@site/versioned_docs/version-v0.0.0/reference/heimdall_scheduler.md","sourceDirName":"reference","slug":"/reference/heimdall_scheduler","permalink":"/reference/heimdall_scheduler","draft":false,"unlisted":false,"tags":[],"version":"v0.0.0","sidebarPosition":1,"frontMatter":{"sidebar_position":1,"title":"Heimdall scheduler"},"sidebar":"docs","previous":{"title":"Reference","permalink":"/reference"},"next":{"title":"Odin inference service","permalink":"/reference/odin_inference_service"}}');var s=i(4848),l=i(8453);const d={sidebar_position:1,title:"Heimdall scheduler"},t="Heimdall scheduler",c={},o=[{value:"Architecture",id:"architecture",level:2},{value:"Control flow",id:"control-flow",level:3},{value:"Plugins",id:"plugins",level:3},{value:"Profile handler",id:"profile-handler",level:4},{value:"Filter",id:"filter",level:4},{value:"Scorer",id:"scorer",level:4},{value:"Picker",id:"picker",level:4},{value:"Configuration",id:"configuration",level:2},{value:"<code>config</code> section",id:"config-section",level:3}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"heimdall-scheduler",children:"Heimdall scheduler"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Heimdall"})," is the component that performs smart routing and scheduling across multiple inference pods, deciding which pod each request should be sent to. It is implemented according to the Kubernetes ",(0,s.jsx)(n.a,{href:"https://gateway-api-inference-extension.sigs.k8s.io/",children:"Gateway API Inference Extension"})," and can operate together with various gateway controllers."]}),"\n",(0,s.jsx)(n.p,{children:"Heimdall's behavior can be flexibly defined by composing multiple scheduling profiles, filters, scorers, and pickers as plugins. The MoAI Inference Framework provides a wide range of plugins \u2014 from advanced plugins that enable fully automated routing and scheduling to low-level plugins that allow fine-grained customization."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.h3,{id:"control-flow",children:"Control flow"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-mermaid",children:"sequenceDiagram\n  participant Gateway\n  participant Inference-pod as Inference pod\n  participant Heimdall\n  participant Scheduling-profile-1 as Scheduling profile 1\n  participant Scheduling-profile-2 as Scheduling profile 2\n\n  Gateway ->>+ Heimdall: Request\n\n  loop\n\n    Note over Heimdall: Profile handler plugin\n\n    alt If the scheduling profile 1 is picked\n\n      Heimdall ->>+ Scheduling-profile-1: Request\n      Note over Scheduling-profile-1: Filter plugins\n      Note over Scheduling-profile-1: Scorer plugins\n      Note over Scheduling-profile-1: Picker plugin\n      Scheduling-profile-1 --\x3e>- Heimdall: Routing candidates\n\n    else If the scheduling profile 2 is picked\n\n      Heimdall ->>+ Scheduling-profile-2: Request\n      Note over Scheduling-profile-2: Filter plugins\n      Note over Scheduling-profile-2: Scorer plugins\n      Note over Scheduling-profile-2: Picker plugin\n      Scheduling-profile-2 --\x3e>- Heimdall: Routing candidates\n\n    end\n\n  end\n\n  Note over Heimdall: Pre-request plugins\n  Heimdall --\x3e>- Gateway: Updated request and routing information\n\n  Gateway ->>+ Inference-pod: Request\n  Inference-pod --\x3e>- Gateway: Response\n\n  Gateway ->>+ Heimdall: Response\n  Note over Heimdall: Post-response plugins\n  Heimdall --\x3e>- Gateway: Updated response\n"})}),"\n",(0,s.jsx)(n.h3,{id:"plugins",children:"Plugins"}),"\n",(0,s.jsxs)(n.p,{children:["MoAI Inference Framework supports six categories of plugins \u2014 ",(0,s.jsx)(n.strong,{children:"profile handler"}),", ",(0,s.jsx)(n.strong,{children:"pre-request"}),", ",(0,s.jsx)(n.strong,{children:"post-response"}),", ",(0,s.jsx)(n.strong,{children:"filter"}),", ",(0,s.jsx)(n.strong,{children:"scorer"}),", and ",(0,s.jsx)(n.strong,{children:"picker"})," plugins. Users need to instantiate and activate some of the plugins to define the behavior of Heimdall."]}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Category"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Instantiation and activation"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Profile handler"}),(0,s.jsx)(n.td,{children:"Determines the scheduling profile(s) to be used for each incoming request."}),(0,s.jsx)(n.td,{children:"Automatically invoked by Heimdall; exactly one profile handler must be instantiated."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Pre-request"}),(0,s.jsx)(n.td,{children:"Performs certain processing or transformations before the request is delivered to a pod."}),(0,s.jsx)(n.td,{children:"Automatically invoked by Heimdall once instantiated."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Post-response"}),(0,s.jsx)(n.td,{children:"Performs certain processing or transformations before the response is delivered to the client."}),(0,s.jsx)(n.td,{children:"Automatically invoked by Heimdall once instantiated."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Filter"}),(0,s.jsx)(n.td,{children:"Restricts the set of pods that a scheduling profile may consider as candidates."}),(0,s.jsx)(n.td,{children:"Becomes active only when included in a scheduling profile."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Scorer"}),(0,s.jsx)(n.td,{children:"Adds a score to each individual pod."}),(0,s.jsx)(n.td,{children:"Becomes active only when included in a scheduling profile."})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Picker"}),(0,s.jsx)(n.td,{children:"Selects the routing target based on the scores of pods."}),(0,s.jsx)(n.td,{children:"Becomes active only when included in a scheduling profile."})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"profile-handler",children:"Profile handler"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Plugin"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Reference"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"single-profile-handler"})}),(0,s.jsxs)(n.td,{children:["Uses the ",(0,s.jsx)(n.code,{children:"default"})," scheduling profile to select a single pod."]}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"pd-profile-handler"})}),(0,s.jsxs)(n.td,{children:["Uses the ",(0,s.jsx)(n.code,{children:"prefill"})," and ",(0,s.jsx)(n.code,{children:"decode"})," scheduling profile to select both prefill-only and decode-only pods."]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/prefill_decode_disaggregation",children:"Prefill-decode disaggregation"})})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"filter",children:"Filter"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Plugin"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Reference"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"decode-filter"})}),(0,s.jsxs)(n.td,{children:["Selects only decode-only pods, and is used by the ",(0,s.jsx)(n.code,{children:"decode"})," scheduling profile."]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/prefill_decode_disaggregation",children:"Prefill-decode disaggregation"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"prefill-filter"})}),(0,s.jsxs)(n.td,{children:["Selects only prefill-only pods, and is used by the ",(0,s.jsx)(n.code,{children:"prefill"})," scheduling profile."]}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/prefill_decode_disaggregation",children:"Prefill-decode disaggregation"})})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"scorer",children:"Scorer"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Plugin"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Reference"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"active-request-scorer"})}),(0,s.jsx)(n.td,{children:"Scores based on the number of active requests."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/load_aware_routing",children:"Load-aware routing"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"load-aware-scorer"})}),(0,s.jsx)(n.td,{children:"Scores based on the number of queued requests."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/load_aware_routing",children:"Load-aware routing"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"no-hit-lru-scorer"})}),(0,s.jsx)(n.td,{children:"Scores based on whether the request hits the prefix cache, and if it misses, when each pod last experienced a miss."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/load_aware_routing",children:"Load-aware routing"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"precise-prefix-cache-scorer"})}),(0,s.jsx)(n.td,{children:"Scores based on the prefix cache hit rate."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/prefix_cache_aware_routing",children:"Prefix cache-aware routing"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"queue-scorer"})}),(0,s.jsx)(n.td,{children:"Scores based on the number of queued requests."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/load_aware_routing",children:"Load-aware routing"})})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"session-affinity-scorer"})}),(0,s.jsx)(n.td,{children:"Scores based on whether the pod has previously handled a request from the same session."}),(0,s.jsx)(n.td,{children:(0,s.jsx)(n.a,{href:"/features/load_aware_routing",children:"Load-aware routing"})})]})]})]}),"\n",(0,s.jsx)(n.h4,{id:"picker",children:"Picker"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Plugin"}),(0,s.jsx)(n.th,{children:"Description"}),(0,s.jsx)(n.th,{children:"Reference"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"max-score-picker"})}),(0,s.jsx)(n.td,{children:"Selects the pod with the highest total score."}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"random-picker"})}),(0,s.jsx)(n.td,{children:"Selects a pod randomly without considering scores."}),(0,s.jsx)(n.td,{})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"weighted-random-picker"})}),(0,s.jsx)(n.td,{children:"Selects a pod randomly with probabilities weighted by their scores."}),(0,s.jsx)(n.td,{})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configuration",children:"Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",metastring:"heimdall-values.yaml",children:"global:\n  imagePullSecrets:\n    - name: moreh-registry\n\nconfig:\n  apiVersion: inference.networking.x-k8s.io/v1alpha1\n  kind: EndpointPickerConfig\n  plugins:\n    - type: pd-profile-handler\n    - type: prefill-filter\n    - type: decode-filter\n    - type: queue-scorer\n    - type: kv-cache-utilization-scorer\n    - type: max-score-picker\n  schedulingProfiles:\n    - name: prefill\n      plugins:\n        - pluginRef: prefill-filter\n        - pluginRef: queue-scorer\n        - pluginRef: kv-cache-utilization-scorer\n        - pluginRef: max-score-picker\n    - name: decode\n      plugins:\n        - pluginRef: decode-filter\n        - pluginRef: queue-scorer\n        - pluginRef: kv-cache-utilization-scorer\n        - pluginRef: max-score-picker\n\ngateway:\n  name: mif\n  gatewayClassName: istio\n\nserviceMonitor:\n  labels:\n    release: prometheus-stack\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"config-section",children:[(0,s.jsx)(n.code,{children:"config"})," section"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"config"})," section defines Heimdall's routing rules. As explained earlier, this is achieved by appropriately combining and configuring multiple plugins."]}),"\n",(0,s.jsxs)(n.p,{children:["This section begins with ",(0,s.jsx)(n.code,{children:"config.apiVersion"})," and ",(0,s.jsx)(n.code,{children:"config.kind"}),", which should be set to ",(0,s.jsx)(n.code,{children:"inference.networking.x-k8s.io/v1alpha1"})," and ",(0,s.jsx)(n.code,{children:"EndpointPickerConfig"}),", respectively."]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"config.plugins"})," list instantiates the plugins to be used, specifying their respective parameters. In most cases, a single instance per plugin is sufficient, but you may instantiate the same plugin multiple times under different names if you need to apply different parameters. Each plugin instance is defined by an entry of the following form:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"- name: <instanceName>\n  type: <pluginName>\n  parameters:\n    <parameter>: <value>\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"name"})," (optional): The name used to reference the plugin instance in scheduling profiles. If omitted, the plugin's ",(0,s.jsx)(n.code,{children:"type"})," is used as its name."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"type"})," (required): The predefined name of the plugin to instantiate."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"parameters"})," (optional): Configuration options specific to this plugin instance."]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["The ",(0,s.jsx)(n.code,{children:"config.schedulingProfiles"})," combines zero or more filter and scorer plugins with exactly one picker plugin to define a rule for making routing decisions. Each scheduling profile is defined by an entry of the following form:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"- name: <profileName>\n  plugins:\n    - pluginRef: <instanceName>\n      weight: <weight>\n"})}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"name"})," (required): The name of the scheduling profile."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"plugins"})," (required): A list of filter, scorer, and picker plugins that make up the scheduling profile.","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"pluginRef"})," (required): The name of the plugin instance as defined in the ",(0,s.jsx)(n.code,{children:"config.plugins"})," section."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"weight"})," (optional, for scorer plugins only): A numerical weight that influences the scoring outcome. Higher weights increase the impact of the scorer on the final decision. If omitted, a default weight of 1 is applied."]}),"\n"]}),"\n"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},8453(e,n,i){i.d(n,{R:()=>d,x:()=>t});var r=i(6540);const s={},l=r.createContext(s);function d(e){const n=r.useContext(l);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:d(e.components),r.createElement(l.Provider,{value:n},e.children)}}}]);